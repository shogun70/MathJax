<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Copyright (c) 2010-2011 Design Science, Inc. -->
<html>
<head>
<title>MathJax Installation Diagnostics</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script src="jquery.js"></script>
<script src="ui.js"></script>
<script>
var mui = MathJaxUI, 
	extend = Object.extend, each = Object.each, forEach = Array.forEach, eachWord = String.eachWord;
	
var queue = function(callback) {
	$(document.body).queue(callback);
}

// Make <input type="checkbox" readonly> non-clickable, so checked state can't be changed by user
$(document).delegate("input", "click", function(event) { if (this.readOnly) event.preventDefault(); });

</script>
<script>
/* SCRIPT OPTIONS
 TODO
 - can these be configurable by search options in the page URL?
 - should there be more resources
*/

var root = ".."; // equivalent to MathJax.Hub.config.root (if MathJax is loaded)

var resources = [ // all these are downloaded
"MathJax.js",
"config/MathJax.js",
"extensions/tex2jax.js",
"jax/input/TeX/config.js",
"jax/input/TeX/jax.js",
"jax/element/mml/jax.js",
"jax/output/HTML-CSS/config.js",
"jax/output/HTML-CSS/jax.js",
"fonts/HTML-CSS/TeX/eot/MathJax_Main-Regular.eot",
"fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf",
"fonts/HTML-CSS/TeX/svg/MathJax_Main-Regular.svg",
"fonts/HTML-CSS/TeX/png/AMS/Regular/050/0020.png",
"fonts/HTML-CSS/TeX/png/Main/Regular/050/0020.png",
"fonts/HTML-CSS/TeX/png/Typewriter/Regular/476/2032.png"
].map(function(fname) { return { name: fname }; });

</script>
<style>
body {
	background-color: #fff;
}
#banner {
	font-family: arial, sans-serif;
	font-weight: bolder;
	color: #aaa;
}
#banner img {
	height: 25px;
}
#banner strong {
	font-size: larger;
	margin-left: 0.5em; 
}
fieldset {
	padding: 0;
	padding-left: 1em;
}
legend {
	font-weight: bold;
}
label {
	background-color: #ccc;
	border: 2px solid #aaa;
	display: inline-block;
	margin: 0.2em; margin-left: 0;
	padding: 0.2em;
	border-radius: 4px;
	-moz-border-radius: 4px;
	-webkit-border-radius: 4px;
}
table {
	border-collapse: collapse;
	width: 100%;
	border: 1px solid #aaa;
	table-layout: fixed;
	margin: 0.2em; margin-left: 0;
}
caption {
	width: auto;
	background-color: #eee;
	border: 1px solid #aaa;
	padding: 0.2em;
	border-radius: 4px 4px 0 0;
	-moz-border-radius: 4px 4px 0 0;
	-webkit-border-radius: 4px 4px 0 0;
}
th, td {
	border: 1px solid #aaa;
	padding: 0.2em;
}
input {	border: none; }
input.interval { border: 1px solid #aaa; }
input.waiting { border: none; background-color: gray; color: white; text-align: center; }
input.loading { border: none; background-color: blue; color: white; text-align: center; }

td.error { background-color: red; }
td.warn { background-color: orange; }

.hidden {
	position: absolute;
	position: fixed;
	top: 0px;
	left: 0px;
	height: 0px;
	width: 100%;
	overflow: hidden;
	visibility: hidden;
}

li.ok { border: 1px solid; border-left: 6px solid green; }
li.warn { border: 1px solid; border-left: 6px solid orange; }
li.error { border: 1px solid; border-left: 6px solid red; }

#summary, #messages {
	width: 80ex;
}
#summary li, #messages li {
	margin: 0;
	margin-bottom: -1px;
	padding: 0.3em;
}
#summary, #summary li, #messages, #messages li {
	list-style-type: none;
	list-style-position: inside;
	padding-left: 0;
	margin-left: 0;
}
#messages ul, #messages ul li {
	list-style-type: disc;
	list-style-position: outside;
	padding: 0.1em;
	padding-left: 0;
}
#summary li { display: none; } /* over-ridden when selected */
#summary li.ok { display: list-item; }
#summary.error li.ok, #summary.warn li.ok { display: none; }
#summary.error li.error { display: list-item; }
#summary.warn li.warn { display: list-item; }

</style>
</head>
<body>
<div id="banner"><img src="logo.gif" /> <strong>Installation Diagnostics</strong></div>

<fieldset><legend id="status">Status: Running</legend>
<ul id="summary">
	<li class="ok"><input type="checkbox" readonly checked /> No issues have been detected</li>
	<li class="error"><input type="checkbox" readonly checked /> Errors have been detected</li>
	<li class="warn"><input type="checkbox" readonly checked /> Performance issues have been detected</li>
</ul>
</fieldset>

<fieldset><legend>Results</legend>
<dl id="messages">

</dl>

<script>
var checks = [
{
	name: "scripts",
	title: "Script files download successfully",
	details: '<ul><li>If some of these do not download it may indicate that MathJax installation did not complete. </li><li>If none of these download it may indicate a configuration problem on the server. </li><li>See the <a href="#files">URL Table</a> for specific results.</li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (res.ext == "js" && res.loaded["class"]) result = "error";
		});
		return result;
	}
},
{
	name: "IEfonts",
	title: "IE fonts (.eot) download successfully",
	details: '<ul><li>If some of these do not download it may indicate that MathJax installation did not complete. </li><li>If none of these download it may indicate a configuration problem on the server. </li><li>See the <a href="#files">URL Table</a> for specific results.</li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (res.ext == "eot" && res.loaded["class"]) result = "error";
		});
		return result;
	}
},
{
	name: "fonts",
	title: "Non-IE font-files (.otf, .svg) download successfully",
	details: '<ul><li>If none of these load this might be due to an IIS server that\
		<a href="http://paulirish.com/2010/font-face-gotchas/">does not have mime-types configured for these files</a>.</li> \
		<li>See the <a href="#files">URL Table</a> for specific results. </li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (/otf|svg/.test(res.ext) && res.loaded["class"]) result = "error";
		});
		return result;
	}
},
{
	name: "images",
	title: "Image-font files (.png) download successfully",
	details: '<ul><li>If some of these do NOT load this may indicate that MathJax installation did not complete. </li>\
		<li>See the <a href="#files">URL Table</a> for specific results. </li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (res.ext == "png" && res.loaded["class"]) result = "error";
		});
		return result;
	}
},
{
	name: "gzip",
	title: "Scripts and font-files are compressed",
	details: '<ul><li>Javascript files (.js) may be compressed on the server (typically using gzip) to decrease network download time.\
		Font files (.otf, .eot, .svg) may also be compressed. </li>\
		<li>This test may not detect compressed files when run in Internet Explorer or if there is a proxy between the browser and the server. </li>\
		<li>See the <a href="#files">URL Table</a> for specific results. </li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (res.ext !== "png" && res.gzip["class"]) result = "warn";
		});
		return result;
	}
},
{
	name: "xdr",
	title: "Font-files are enabled for cross-domain requests",
	details: '<ul><li>If the MathJax distribution is intended for cross-domain use then font-files need to be served with\
		<code>Access-Control-Allow-Origin: "*"</code> HTTP header. </li>\
		<li>See the <a href="#files">URL Table</a> for specific results.</li></ul>',
	test: function(resources) {
		var result = "ok";
		resources.forEach(function(res) {
			if (/otf|eot|svg/.test(res.ext) && res.xdr["class"]) result = "warn";
		});
		return result;
	}
}
];

var runChecks = function(resources) {
	Array.forEach(checks, function(check) {
		var $item = $('<li id="' + check.name + '">' +
		'<dt><input type="checkbox" readonly /><a href="#">' + check.title + '</a></dt>' + 
		'<dd>' + check.details + '</dd>' +
		'</li>');
		var result = check.test(resources);
		$item.addClass(result);
		if (result == "ok") $item.find("dt input").attr("checked", true);
		$item.appendTo("#messages").find("dt a").click();
		if (result == "warn" || result == "error") $("#summary").addClass(result);
	});
}

$("#messages").delegate("dt a", "click", function(e) { $(this).parent().next().toggleClass("hidden"); return false; }).find("dt a").click();
</script>
</fieldset>

<script>
var ui = {

postResult: function(id, flag) {
	var item = $("#" + id);
	item.addClass(flag);
	if (flag == "ok") item.find("input")[0].checked = true;
	if (flag == "warn" || flag == "error") $("#summary").addClass(flag);
},

updateStatus: function(msg) {
	$("#status").html(msg);
}

}
</script>


<form action="mailto:" method="post" enctype="text/plain">
<div id="results">

<table id="files" class="hidden">
	<caption>URL Table</caption>
	<col style="width: 20em;" />
	<col style="width: 4em;" />
	<col style="width: 4em;" />
	<col style="width: 4em;" />
	<col style="width: auto;" />
	<thead>
		<tr>
			<th>File</th>
			<th title="File successfully loaded">Loaded</th>
			<th title="Compression is enabled - a performance optimization">Gzip</th>
			<th title="Cross-domain requests enabled">XDR</th>
			<th title="Timing data only relevant with empty cache; not accurate in all browsers.">Timeline</th>
		</tr>
	</thead>
	<tbody id="files-table">
		<tr class="template">
			<td align="left" style="overflow: hidden;"><input name="name" readonly size="60" /></td>
			<td align="center"><input type="checkbox" name="loaded" readonly /></td>
			<td align="center"><input type="checkbox" name="gzip" readonly /></td>
			<td align="center"><input type="checkbox" name="xdr" readonly /></td>
			<td align="left"><input class="waiting interval" name="waiting" readonly /><input class="loading interval" name="loading" readonly /></td>
		</tr>
	</tbody>
</table>

<script>
(function() {

var table = $("#files");
table.removeClass("hidden");
var uriTable = new mui.DataTable(table[0]);

var fetch = function(fname, callback) {
	var url = root + "/" + fname + "?" + Date.now();
	var t = {};
	var rq = $.ajaxSettings.xhr();
	rq.onreadystatechange = function() {
		var now = Date.now();
		switch(rq.readyState) {
			case 2:
				t.headers = now;
				break;
			case 4:
				t.complete = now;
				callback(rq, t);
				break;
		}
	}
	rq.open("get", url, true);
	rq.setRequestHeader("If-Modified-Since", "" + (new Date(0)).toUTCString());
	rq.send();
	t.start = Date.now();
}

var checkResource = function(res, next) {
	var callback = function(rq, t) {
		var fname = res.name, ext = fname.split(".").pop();
		var loaded = (rq.status == 200), // TODO will there be other valid status-codes??
			contentEncoding = rq.getResponseHeader("Content-Encoding"),
			contentLength = rq.getResponseHeader("Content-Length"),
			gzip = !!(loaded && (/gzip|deflate/.test(contentEncoding) || !contentEncoding && !contentLength)),
			allowOrigin = rq.getResponseHeader("Access-Control-Allow-Origin"),
			crossSite = !!(loaded && allowOrigin === "*"),
			waiting = t.headers - t.start,
			loading = t.complete - t.headers,
			total = t.complete - t.start,
			timelineMsg = "latency: " + waiting + " / download: " + loading + " / total: " + total;
		Object.extend(res, {
			ext: ext,
			loaded: { value: loaded, "class": !loaded ? "error" : null }, 
			gzip: { value: gzip, title: contentEncoding, "class": (!gzip && ext !== "png") ? "warn" : null },
			xdr: { value: crossSite, title: allowOrigin, "class": (!crossSite && (ext !== "js" && ext !== "png")) ? "warn" : null },
			waiting: { value: waiting, title: timelineMsg },
			loading: { value: loading, title: timelineMsg },
			total: total
		});
	}
	fetch(res.name, function(rq, t) {
		callback(rq, t);
		next();
	});
}

resources.forEach(function(res) {
	queue(function(next) { checkResource(res, next); }); 
});

queue(function(next) {
	var maxTime = 0;
	resources.forEach(function(res) {
		if (res.total > maxTime) maxTime = res.total;
	});
	uriTable.scale = 95 / maxTime;
	resources.forEach(function(res) {
		uriTable.addRow(res);
	});
	next();
});

queue(function(next) {
	runChecks(resources);
	next();
});

})();

queue(function() {
	ui.updateStatus("Status: Complete");
});

</script>


</div>
</form>

</body>

</html>
