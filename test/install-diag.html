<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
<title>MathJax Installation Diagnostics</title>
<!-- Copyright (c) 2010 Design Science, Inc. -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
body {
	background-color: #fff;
}
#banner {
	font-family: arial, sans-serif;
	font-weight: bolder;
	color: #aaa;
}
#banner img {
	height: 25px;
}
#banner strong {
	font-size: larger;
	margin-left: 0.5em; 
}
fieldset {
	padding: 0;
	padding-left: 1em;
}
legend {
	font-weight: bold;
}
label {
	background-color: #ccc;
	border: 2px solid #aaa;
	display: inline-block;
	margin: 0.2em; margin-left: 0;
	padding: 0.2em;
	border-radius: 4px;
	-moz-border-radius: 4px;
	-webkit-border-radius: 4px;
}
table {
	border-collapse: collapse;
	width: 100%;
	border: 1px solid #aaa;
	table-layout: fixed;
	margin: 0.2em; margin-left: 0;
}
caption {
	width: auto;
	background-color: #eee;
	border: 1px solid #aaa;
	padding: 0.2em;
	border-radius: 4px 4px 0 0;
	-moz-border-radius: 4px 4px 0 0;
	-webkit-border-radius: 4px 4px 0 0;
}
th, td {
	border: 1px solid #aaa;
	padding: 0.2em;
}
input {	border: none; }
input.duration { border: 1px solid #aaa; }
input[name=waiting] { border: none; background-color: gray; color: white; text-align: center; }
input[name=loading] { border: none; background-color: blue; color: white; text-align: center; }

td.error { background-color: red; }
td.warn { background-color: orange; }

.hidden {
	position: absolute;
	position: fixed;
	top: 0px;
	left: 0px;
	height: 0px;
	width: 100%;
	overflow: hidden;
	visibility: hidden;
}

li.ok { border: 1px solid; border-left: 6px solid green; }
li.warn { border: 1px solid; border-left: 6px solid orange; }
li.error { border: 1px solid; border-left: 6px solid red; }

#summary, #summary li, #messages, #messages li {
	list-style-type: none;
	list-style-position: inside;
	padding-left: 0;
	margin-left: 0;
}
#summary li, #messages li {
	display: none;
	width: 80ex;
	margin: 0;
	margin-bottom: -1px;
	padding: 0.3em;
}
#summary li.ok { display: list-item; }
#summary.error li.ok, ul#summary.warn li.ok { display: none; }
#summary.error li.error { display: list-item; }
#summary.warn li.warn { display: list-item; }

#messages li.ok { display: list-item; }
#messages li.error { display: list-item; }
#messages li.warn { display: list-item; }

</style>
<script src="jquery.js"></script>
<script src="ui.js"></script>
<script>
var mui = MathJaxUI, 
	extend = Object.extend, each = Object.each, forEach = Array.forEach, eachWord = String.eachWord;
	
var queue = function(callback) {
	$(document.body).queue(callback);
}

</script>

</head>
<body>
<div id="banner"><img src="logo.gif" /> <strong>Installation Diagnostics</strong></div>

<fieldset><legend id="status">Status: Running</legend>
<ul id="summary">
	<li class="ok"><input type="radio" readonly checked /> No issues have been detected</li>
	<li class="error"><input type="radio" readonly checked /> Errors have been detected</li>
	<li class="warn"><input type="radio" readonly checked /> Performance issues have been detected</li>
</ul>
</fieldset>

<fieldset><legend>Results</legend>
<dl id="messages">
	<li id="script">
		<dt><input type="checkbox" readonly /><a href="#">MathJax script loads</a></dt>
		<dd><small>If the MathJax script doesn't load then probably all other tests will fail.
		The script file may be corrupted or in an unexpected location.
		This test-page expects to find the script at <a href="../MathJax.js">../MathJax.js</a>.
		</small></dd>
	</li>
	<li id="config">
		<dt><input type="checkbox" readonly /><a href="#">MathJax configuration successful</a></dt>
		<dd><small>If MathJax configuration is not successful the script file may be corrupted.
		</small></dd>
	</li>
	<li id="scripts">
		<dt><input type="checkbox" readonly /><a href="#">All script files download successfuly</a></dt>
		<dd><small>See the <a href="#files">URL Table</a> for specific results.
		</small></dd>
	</li>
	<li id="IEfonts">
		<dt><input type="checkbox" readonly /><a href="#">All IE font-files (.eot) download successfuly</a></dt>
		<dd><small>See the <a href="#files">URL Table</a> for specific results.
		</small></dd>
	</li>
	<li id="fonts">
		<dt><input type="checkbox" readonly /><a href="#">All non-IE font-files (.otf, .svg) download successfuly</a></dt>
		<dd><small>If none of these load this might be due to an IIS server that
		<a href="http://paulirish.com/2010/font-face-gotchas/">does not have mime-types configured for these files</a>. 
		See the <a href="#files">URL Table</a> for specific results. 
		</small></dd>
	</li>
	<li id="images">
		<dt><input type="checkbox" readonly /><a href="#">All image-font files (.png) download successfuly</a></dt>
		<dd><small>If some of these files do NOT load this may indicate that MathJax installation did not complete. <br />
		See the <a href="#files">URL Table</a> for specific results. 
		</small></dd>
	</li>
	<li id="gzip">
		<dt><input type="checkbox" readonly /><a href="#">Scripts and font-files are compressed</a></dt>
		<dd><small>Javascript files (.js) may be compressed on the server (typically using gzip) to decrease network download time.
		Font files (.otf, .eot, .svg) may also be compressed. See the <a href="#files">URL Table</a> for specific results. <br />
		</small></dd>
	</li>
	<li id="xdr">
		<dt><input type="checkbox" readonly /><a href="#">Font-files are enabled for cross-domain requests</a></dt>
		<dd><small>If the MathJax distribution is intended for cross-domain use then font-files need to be served with
		<code>Access-Control-Allow-Origin: "*"</code> HTTP header. 
		See the <a href="#files">URL Table</a> for specific results.
		</small></dd>
	</li>
		
</dl>

<script>
$("#messages dt a").click(function(e) { $(this).parent().next().toggleClass("hidden"); return false; }).click();
</script>
</fieldset>

<script>
var ui = {

postResult: function(id, flag) {
	var item = $("#" + id);
	item.addClass(flag);
	if (flag == "ok") item.find("input")[0].checked = true;
	if (flag == "warn" || flag == "error") $("#summary").addClass(flag);
},

updateStatus: function(msg) {
	$("#status").html(msg);
}

}

var results = {
	script: "error",
	config: "error",
	scripts: "ok",
	IEfonts: "ok",
	fonts: "ok",
	images: "ok",
	gzip: "ok",
	xdr: "ok"
}
</script>


<form action="mailto:" method="post" enctype="text/plain">
<div id="results">
	
<script type="text/javascript" src="../MathJax.js">
  results.script = "ok";

  MathJax.Hub.Config({
	skipStartupTypeset: true,
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {
		inlineMath: [["$","$"],["\\(","\\)"]],
		displayMath: [["$$","$$"]]
	}
  });

  results.config = "ok";
</script>
<script>
ui.postResult("script", results.script);
ui.postResult("config", results.config);
</script>
	
<table id="files" class="hidden">
	<caption>URL Table</caption>
	<col style="width: 20em;" />
	<col style="width: 4em;" />
	<col style="width: 4em;" />
	<col style="width: 4em;" />
	<col style="width: auto;" />
	<thead>
		<tr>
			<th>File</th>
			<th title="File successfully loaded">Loaded</th>
			<th title="Compression is enabled - a performance optimization">Gzip</th>
			<th title="Cross-domain requests enabled">XDR</th>
			<th title="Timing data only relevant with empty cache">Timeline</th>
		</tr>
	</thead>
	<tbody id="files-table">
		<tr class="template">
			<td align="left" style="overflow: hidden;"><input name="name" readonly size="60" /></td>
			<td align="center"><input type="checkbox" name="loaded" readonly /></td>
			<td align="center"><input type="checkbox" name="gzip" readonly /></td>
			<td align="center"><input type="checkbox" name="xdr" readonly /></td>
			<td align="left"><input class="duration" name="waiting" readonly /><input class="duration" name="loading" readonly /></td>
		</tr>
	</tbody>
</table>

<script>
if (window.MathJax) (function() {

var table = $("#files");
table.removeClass("hidden");
var uriTable = new mui.DataTable(table[0]);

var resources = [
"MathJax.js",
"config/MathJax.js",
"extensions/tex2jax.js",
"jax/input/TeX/config.js",
"jax/input/TeX/jax.js",
"jax/element/mml/jax.js",
"jax/output/HTML-CSS/config.js",
"jax/output/HTML-CSS/jax.js",
"fonts/HTML-CSS/TeX/eot/MathJax_Main-Regular.eot",
"fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf",
"fonts/HTML-CSS/TeX/svg/MathJax_Main-Regular.svg",
"fonts/HTML-CSS/TeX/png/AMS/Regular/050/0020.png",
"fonts/HTML-CSS/TeX/png/Main/Regular/050/0020.png",
"fonts/HTML-CSS/TeX/png/Typewriter/Regular/476/2032.png"
].map(function(fname) { return { name: fname }; });

var root = MathJax.Hub.config.root;
var fetch = function(fname, callback) {
	var url = root + "/" + fname + "?" + Date.now();
	var t = {};
	var rq = new XMLHttpRequest;
	rq.onreadystatechange = function() {
		var now = Date.now();
		switch(rq.readyState) {
			case 2:
				t.headers = now;
				break;
			case 4:
				t.complete = now;
				callback(rq, t);
				break;
		}
	}
	rq.open("get", url, true);
	rq.setRequestHeader("If-Modified-Since", "" + (new Date(0)).toUTCString());
	rq.send();
	t.start = Date.now();
}

var rcStats = {
	maxTime: 0
}
var checkResource = function(res, next) {
	var callback = function(rq, t) {
		var fname = res.name, ext = fname.split(".").pop();
		var loaded = (rq.status == 200), // TODO will there be other valid status-codes??
			contentEncoding = rq.getResponseHeader("Content-Encoding"),
			contentLength = rq.getResponseHeader("Content-Length"),
			gzip = !!(loaded && (/gzip|deflate/.test(contentEncoding) || !contentEncoding && !contentLength)),
			allowOrigin = rq.getResponseHeader("Access-Control-Allow-Origin"),
			crossSite = !!(loaded && allowOrigin === "*"),
			waiting = t.headers - t.start,
			loading = t.complete - t.headers,
			total = t.complete - t.start,
			timelineMsg = "latency: " + waiting + " / download: " + loading + " / total: " + total;
		Object.extend(res, {
			loaded: { value: loaded, "class": !loaded ? "error" : null }, 
			gzip: { value: gzip, title: contentEncoding, "class": (!gzip && ext !== "png") ? "warn" : null },
			xdr: { value: crossSite, title: allowOrigin, "class": (!crossSite && (ext !== "js" && ext !== "png")) ? "warn" : null },
			waiting: { value: waiting, title: timelineMsg },
			loading: { value: loading, title: timelineMsg },
			total: total
		});
		if (res.loaded["class"]) {
			switch (ext) {
				case "js": results.scripts = "error"; break;
				case "eot": results.IEfonts = "error"; break;
				case "otf": case "svg": results.fonts = "error"; break;
				case "png": results.images = "error"; break;
			}
		}
		if (res.gzip["class"]) results.gzip = "warn";
		if (res.xdr["class"]) results.xdr = "warn";
		if (res.total > rcStats.maxTime) rcStats.maxTime = res.total;
	}
	fetch(res.name, function(rq, t) {
		callback(rq, t);
		next();
	});
}

resources.forEach(function(res) {
	queue(function(next) { checkResource(res, next); }); 
});

queue(function(next) { 
	uriTable.scale = 95 / rcStats.maxTime;
	resources.forEach(function(res) {
		uriTable.addRow(res);
	});
	next();
});

queue(function(next) {
	ui.postResult("scripts", results.scripts);
	ui.postResult("IEfonts", results.IEfonts);
	ui.postResult("fonts", results.fonts);
	ui.postResult("images", results.images);
	ui.postResult("gzip", results.gzip);
	ui.postResult("xdr", results.xdr);
	next();
});

})();

var end = function() {
	ui.updateStatus("Status: Complete");
}
if (MathJax) queue(end)
else end();
</script>


</div>
</form>

</body>

</html>
